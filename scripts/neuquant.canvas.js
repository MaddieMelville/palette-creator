((function(){var a,b=Object.prototype.hasOwnProperty,c=Array.prototype.indexOf||function(a){for(var c=0,d=this.length;c<d;c++)if(b.call(this,c)&&this[c]===a)return c;return-1},d=Array.prototype.slice;({root:typeof exports!="undefined"&&exports!==null?exports:this}),a=function(){function a(a,b,d){var e,f,g,h,i,j,k;e=a.length>>2,this.prime1=499,this.prime2=491,this.prime3=487,this.prime4=503,this.maxprime=this.prime4;if(e<this.maxprime)throw"Image is too small";if(h=!b,c.call(function(){j=[];for(f=1;f<=30;f++)j.push(f);return j}.apply(this),h)>=0)throw"Sample must be 1..30";if(i=!d,c.call(function(){k=[];for(g=4;g<=256;g++)k.push(g);return k}.apply(this),i)>=0)throw"Color count must be 4..256";this.ncycles=100,this.pixels=a,this.sample=b,this.netsize=d,this.specials=1,this.bgcolor=this.specials-1,this.cutnetsize=this.netsize-this.specials,this.maxnetpos=this.netsize-1,this.initradius=Math.floor(this.netsize/8),this.radiusbiasshift=6,this.radiusbias=1<<this.radiusbiasshift,this.initbiasradius=this.initradius*this.radiusbias,this.radiusdec=30,this.alphabiasshift=10,this.initalpha=1<<this.alphabiasshift,this.gamma=1024,this.beta=1/1024,this.betagamma=this.beta*this.gamma,this.setupArrays()}return a.prototype.setupArrays=function(){var a,b,c,d,e;this.network=this.createArray(0,this.netsize,3),this.colormap=this.createArray(0,this.netsize,4),this.netindex=this.createArray(0,256),this.bias=this.createArray(0,this.netsize),this.freq=this.createArray(0,this.netsize),this.network[0][0]=0,this.network[0][1]=0,this.network[0][2]=0,this.network[1][0]=255,this.network[1][1]=255,this.network[1][2]=255;for(a=0,c=this.specials;0<=c?a<c:a>c;0<=c?a++:a--)this.freq[a]=1/this.netsize,this.bias[a]=0;for(a=d=this.specials,e=this.netsize;d<=e?a<e:a>e;d<=e?a++:a--)b=this.network[a],b[0]=255*(a-this.specials)/this.cutnetsize,b[1]=255*(a-this.specials)/this.cutnetsize,b[2]=255*(a-this.specials)/this.cutnetsize,this.freq[a]=1/this.netsize,this.bias[a]=0;return this},a.prototype.createArray=function(){var a,b,c,e,f,g,h;g=arguments[0],c=2<=arguments.length?d.call(arguments,1):[];if(c==null||c.length===0)return g;b=new Array(c.shift()),f=arguments.callee,a=[g].concat(c);for(e=0,h=b.length;0<=h?e<h:e>h;0<=h?e++:e--)b[e]=f.apply(this,a);return b},a.prototype.init=function(){return this.learn(),this.fix(),this.build(),this},a.prototype.learn=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;e=this.initbiasradius,c=30+Math.floor((this.sample-1)/3),j=this.pixels.length>>2,n=Math.floor(j/this.sample),f=Math.floor(n/this.ncycles),b=this.initalpha,m=e>>this.radiusbiasshift,m<=1&&(m=0),typeof console!="undefined"&&console!==null&&console.log("Beginning 1D learning: sample pixels = "+n+"; radius = "+m),o=0,k=0,j%this.prime1!==0?o=this.prime1:j%this.prime2!==0?o=this.prime2:j%this.prime3!==0?o=this.prime3:o=this.prime4,h=0;while(h<n){p=k<<2,l=this.pixels[p],g=this.pixels[p+1],d=this.pixels[p+2],i=this.specialFind(d,g,l),i=i<0?this.contest(d,g,l):i,i>=this.specials&&(a=b/this.initalpha,this.alterSingle(a,i,d,g,l),m>0&&this.alterNeighbors(a,m,i,d,g,l)),k+=o;while(k>=j)k-=j;h++,h%f===0&&(b-=Math.floor(b/c),e-=Math.floor(e/this.radiusdec),m=e>>this.radiusbiasshift,m<=1&&(m=0))}return typeof console!="undefined"&&console!==null&&console.log("Finished 1D learning: final alpha = "+b/this.initalpha),this},a.prototype.fix=function(){var a,b,c,d;for(a=0,d=this.netsize;0<=d?a<d:a>d;0<=d?a++:a--){for(b=0;b<3;b++)c=Math.floor(.5+this.network[a][b]),c<0?c=0:c>255&&(c=255),this.colormap[a][b]=c;this.colormap[a][3]=a}return this},a.prototype.build=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;d=0,h=0;for(a=0,i=this.netsize;0<=i?a<i:a>i;0<=i?a++:a--){c=this.colormap[a],e=null,f=a,g=c[1];for(b=j=a+1,k=this.netsize;j<=k?b<k:b>k;j<=k?b++:b--)e=this.colormap[b],e[1]<g&&(f=b,g=e[1]);e=this.colormap[f],a!==f&&(l=[e[0],c[0]],c[0]=l[0],e[0]=l[1],m=[e[1],c[1]],c[1]=m[0],e[1]=m[1],n=[e[2],c[2]],c[2]=n[0],e[2]=n[1],o=[e[3],c[3]],c[3]=o[0],e[3]=o[1]);if(g!==d){this.netindex[d]=h+a>>1;for(b=p=d+1;p<=g?b<g:b>g;p<=g?b++:b--)this.netindex[b]=a;d=g,h=a}}this.netindex[d]=h+this.maxnetpos>>1;for(b=q=d+1;q<=256?b<256:b>256;q<=256?b++:b--)this.netindex[b]=this.maxnetpos;return this},a.prototype.alterSingle=function(a,b,c,d,e){var f;return f=this.network[b],f[0]-=a*(f[0]-c),f[1]-=a*(f[1]-d),f[2]-=a*(f[2]-e),this},a.prototype.alterNeighbors=function(a,b,c,d,e,f){var g,h,i,j,k,l,m;k=c-b,k<this.specials-1&&(k=this.specials-1),h=c+b,h>this.netsize&&(h=this.netsize),i=c+1,j=c-1,m=0;while(i<h||j>k)g=a*(b*b-m*m)/(b*b),m++,i<h&&(l=this.network[i],l[0]-=g*(l[0]-d),l[1]-=g*(l[1]-e),l[2]-=g*(l[2]-f),i++),j>k&&(l=this.network[j],l[0]-=g*(l[0]-d),l[1]-=g*(l[1]-e),l[2]-=g*(l[2]-f),j--);return this},a.prototype.specialFind=function(a,b,c){var d,e,f;for(d=0,f=this.specials;0<=f?d<f:d>f;0<=f?d++:d--){e=this.network[d];if(e[0]===a&&e[1]===b&&e[2]===c)return d}return-1},a.prototype.contest=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;g=Number.MAX_VALUE,e=g,h=-1,f=h;for(k=m=this.specials,n=this.netsize;m<=n?k<n:k>n;m<=n?k++:k--)l=this.network[k],j=l[0]-a,j<0&&(j=-j),d=l[1]-b,d<0&&(d=-d),j+=d,d=l[2]-c,d<0&&(d=-d),j+=d,j<g&&(g=j,h=k),i=j-this.bias[k],i<e&&(e=i,f=k),this.freq[k]-=this.beta*this.freq[k],this.bias[k]+=this.betagamma*this.freq[k];return this.freq[h]+=this.beta,this.bias[h]-=this.betagamma,f},a.prototype.convertPixels=function(a){var b,c,d,e,f,g,h,i;f=a.length>>2;for(e=0;0<=f?e<f:e>f;0<=f?e++:e--)i=e<<2,h=a[i],d=a[i+1],c=a[i+2],b=a[i+3],g=this.convertPixel(b,h,d,c),a[i]=g[0],a[i+1]=g[1],a[i+2]=g[2],a[i+3]=g[3];return a},a.prototype.convertPixel=function(a){var b,c,d,e;return b=a>>24&255,e=a>>16&255,d=a>>8&255,c=a&255,this.convertPixel(b,e,d,c)},a.prototype.convertPixel=function(a,b,c,d){var e;return e=this.search(d,c,b),d=this.colormap[e][0],c=this.colormap[e][1],b=this.colormap[e][2],[b,c,d,a]},a.prototype.search=function(a,b,c){var d,e,f,g,h,i,j;f=1e3,e=-1,h=this.netindex[b],i=h-1;while(h<this.netsize||i>=0)h<this.netsize&&(j=this.colormap[h],g=j[1]-b,g>=f?h=this.netsize:(g<0&&(g=-g),d=j[0]-a,d<0&&(d=-d),g+=d,g<f&&(d=j[2]-c,d<0&&(d=-d),g+=d,g<f&&(f=g,e=h)),h++)),i>=0&&(j=this.colormap[i],g=b-j[1],g>=f?i=-1:(g<0&&(g=-g),d=j[0]-a,d<0&&(d=-d),g+=d,g<f&&(d=j[2]-c,d<0&&(d=-d),g+=d,g<f&&(f=g,e=i)),i--));return e},a.prototype.getColorCount=function(){return this.netsize},a.prototype.getColorMap=function(){var a,b,c,d,e,f,g;c=[];for(e=0,g=this.netsize;0<=g?e<g:e>g;0<=g?e++:e--)b=this.colormap[e][0],d=this.colormap[e][1],f=this.colormap[e][2],a=255,c.push(f),c.push(d),c.push(b),c.push(a);return c},a}(),root.NeuQuant=a})).call(this);