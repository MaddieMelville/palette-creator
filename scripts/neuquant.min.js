(function(){var a;var b=Array.prototype.slice;({root:(typeof exports!=="undefined"&&exports!==null)?exports:this});a=function(j,f,i){var h,c,g,e,d;d=j.length>>2;this.prime1=499;this.prime2=491;this.prime3=487;this.prime4=503;this.maxprime=this.prime4;if(d<this.maxprime){throw"Image is too small"}if((function(){for(var l=0,k=(g=(function(){e=[];for(l=1;l<=30;l++){e.push(l)}return e}).call(this)).length;l<k;l++){if(g[l]===!f){return true}}return false}).call(this)){throw"Sample must be 1..30"}if((function(){for(var l=0,k=(g=(function(){e=[];for(l=4;l<=256;l++){e.push(l)}return e}).call(this)).length;l<k;l++){if(g[l]===!i){return true}}return false}).call(this)){throw"Color count must be 4..256"}this.ncycles=100;this.pixels=j;this.sample=f;this.netsize=i;this.specials=1;this.bgcolor=this.specials-1;this.cutnetsize=this.netsize-this.specials;this.maxnetpos=this.netsize-1;this.initradius=Math.floor(this.netsize/8);this.radiusbiasshift=6;this.radiusbias=1<<this.radiusbiasshift;this.initbiasradius=this.initradius*this.radiusbias;this.radiusdec=30;this.alphabiasshift=10;this.initalpha=1<<this.alphabiasshift;this.gamma=1024;this.beta=1/1024;this.betagamma=this.beta*this.gamma;this.setupArrays();return this};a.prototype.setupArrays=function(){var d,f,c,e;this.network=this.createArray(0,this.netsize,3);this.colormap=this.createArray(0,this.netsize,4);this.netindex=this.createArray(0,256);this.bias=this.createArray(0,this.netsize);this.freq=this.createArray(0,this.netsize);this.network[0][0]=0;this.network[0][1]=0;this.network[0][2]=0;this.network[1][0]=255;this.network[1][1]=255;this.network[1][2]=255;d=this.specials;for(c=0;(0<=d?c<d:c>d);(0<=d?c+=1:c-=1)){this.freq[c]=1/this.netsize;this.bias[c]=0}d=this.specials;f=this.netsize;for(c=d;(d<=f?c<f:c>f);(d<=f?c+=1:c-=1)){e=this.network[c];e[0]=(255*(c-this.specials))/this.cutnetsize;e[1]=(255*(c-this.specials))/this.cutnetsize;e[2]=(255*(c-this.specials))/this.cutnetsize;this.freq[c]=1/this.netsize;this.bias[c]=0}return this};a.prototype.createArray=function(j){var h,e,c,g,f,d;g=b.call(arguments,1);if(!(g!=null)||g.length===0){return j}c=new Array(g.shift());d=arguments.callee;e=[j].concat(g);h=c.length;for(f=0;(0<=h?f<h:f>h);(0<=h?f+=1:f-=1)){c[f]=d.apply(this,e)}return c};a.prototype.init=function(){this.learn();this.fix();this.build();return this};a.prototype.learn=function(){var v,h,m,u,f,w,o,n,l,q,d,t,c,s,k,e;f=this.initbiasradius;m=30+Math.floor((this.sample-1)/3);q=this.pixels.length;k=Math.floor(q/this.sample);w=Math.floor(k/this.ncycles);h=this.initalpha;s=f>>this.radiusbiasshift;if(s<=1){s=0}if(typeof console!=="undefined"&&console!==null){console.log("Beginning 1D learning: sample pixels = "+k+"; radius = "+s)}e=0;t=0;if(q%this.prime1!==0){e=this.prime1}else{if(q%this.prime2!==0){e=this.prime2}else{if(q%this.prime3!==0){e=this.prime3}else{e=this.prime4}}}n=0;while(n<k){d=this.pixels[t];c=(d>>16)&255;o=(d>>8)&255;u=(d)&255;if(n===0){this.network[this.bgcolor][0]=u;this.network[this.bgcolor][1]=o;this.network[this.bgcolor][2]=c}l=this.specialFind(u,o,c);l=l<0?this.contest(u,o,c):l;if(l>=this.specials){v=h/this.initalpha;this.alterSingle(v,l,u,o,c);if(s>0){this.alterNeighbors(v,s,l,u,o,c)}}t+=e;while(t>=q){t-=q}n++;if(n%w===0){h-=Math.floor(h/m);f-=Math.floor(f/this.radiusdec);s=f>>this.radiusbiasshift;if(s<=1){s=0}}}if(typeof console!=="undefined"&&console!==null){console.log("Finished 1D learning: final alpha = "+(h/this.initalpha))}return this};a.prototype.fix=function(){var f,e,d,c;f=this.netsize;for(e=0;(0<=f?e<f:e>f);(0<=f?e+=1:e-=1)){for(d=0;d<3;d++){c=Math.floor(0.5+this.network[e][d]);if(c<0){c=0}else{if(c>255){c=255}}this.colormap[e][d]=c}this.colormap[e][3]=e}return this};a.prototype.build=function(){var l,g,f,m,k,e,c,d,h,o,n;c=0;n=0;l=this.netsize;for(m=0;(0<=l?m<l:m>l);(0<=l?m+=1:m-=1)){e=this.colormap[m];d=null;h=m;o=e[1];g=m+1;f=this.netsize;for(k=g;(g<=f?k<f:k>f);(g<=f?k+=1:k-=1)){d=this.colormap[k];if(d[1]<o){h=k;o=d[1]}}d=this.colormap[h];if(m!==h){g=[d[0],e[0]],e[0]=g[0],d[0]=g[1];g=[d[1],e[1]],e[1]=g[0],d[1]=g[1];g=[d[2],e[2]],e[2]=g[0],d[2]=g[1];g=[d[3],e[3]],e[3]=g[0],d[3]=g[1]}if(o!==c){this.netindex[c]=(n+m)>>1;g=c+1;for(k=g;(g<=o?k<o:k>o);(g<=o?k+=1:k-=1)){this.netindex[k]=m}c=o;n=m}}this.netindex[c]=(n+this.maxnetpos)>>1;l=c+1;for(k=l;(l<=256?k<256:k>256);(l<=256?k+=1:k-=1)){this.netindex[k]=this.maxnetpos}return this};a.prototype.alterSingle=function(h,d,c,f,e){var j;j=this.network[d];j[0]-=(h*(j[0]-c));j[1]-=(h*(j[1]-f));j[2]-=(h*(j[2]-e));return this};a.prototype.alterNeighbors=function(l,t,n,u,o,c){var v,f,m,h,s,e,d;s=n-t;if(s<this.specials-1){s=this.specials-1}f=n+t;if(f>this.netsize){f=this.netsize}m=n+1;h=n-1;d=0;while(m<f||h>s){v=(l*(t*t-d*d))/(t*t);d++;if(m<f){e=this.network[m];e[0]-=(v*(e[0]-u));e[1]-=(v*(e[1]-o));e[2]-=(v*(e[2]-c));m++}if(h>s){e=this.network[h];e[0]-=(v*(e[0]-u));e[1]-=(v*(e[1]-o));e[2]-=(v*(e[2]-c));h--}}return this};a.prototype.specialFind=function(c,f,e){var h,d,j;h=this.specials;for(d=0;(0<=h?d<h:d>h);(0<=h?d+=1:d-=1)){j=this.network[d];if(j[0]===c&&j[1]===f&&j[2]===e){return d}}return -1};a.prototype.contest=function(q,m,d){var k,f,s,c,o,j,l,t,p,h,e;j=Number.MAX_VALUE;c=j;l=-1;o=l;k=this.specials;f=this.netsize;for(h=k;(k<=f?h<f:h>f);(k<=f?h+=1:h-=1)){e=this.network[h];p=e[0]-q;if(p<0){p=-p}s=e[1]-m;if(s<0){s=-s}p+=s;s=e[2]-d;if(s<0){s=-s}p+=s;if(p<j){j=p;l=h}t=p-this.bias[h];if(t<c){c=t;o=h}this.freq[h]-=this.beta*this.freq[h];this.bias[h]+=this.betagamma*this.freq[h]}this.freq[l]+=this.beta;this.bias[l]-=this.betagamma;return o};a.prototype.convertPixels=function(e){var d,c;d=e.length;for(c=0;(0<=d?c<d:c>d);(0<=d?c+=1:c-=1)){e[c]=this.convertPixel(e[c])}return e};a.prototype.convertPixel=function(e){var d,c,h,f;d=(e>>24)&255;f=(e>>16)&255;h=(e>>8)&255;c=(e)&255;return this.convertPixel(d,f,h,c)};a.prototype.convertPixel=function(d,k,j,c){var l,f,h,e;h=this.search(c,j,k);l=this.colormap[h][0];f=this.colormap[h][1];e=this.colormap[h][2];return(d<<24)|(e<<16)|(f<<8)|(l)};a.prototype.search=function(n,l,c){var o,e,k,m,h,f,d;k=1000;e=-1;h=this.netindex[l];f=h-1;while(h<this.netsize||(f>=0)){if(h<this.netsize){d=this.colormap[h];m=d[1]-l;if(m>=k){h=this.netsize}else{if(m<0){m=-m}o=d[0]-n;if(o<0){o=-o}m+=o;if(m<k){o=d[2]-c;if(o<0){o=-o}m+=o;if(m<k){k=m;e=h}}h++}}if(f>=0){d=this.colormap[f];m=l-d[1];if(m>=k){f=-1}else{if(m<0){m=-m}o=d[0]-n;if(o<0){o=-o}m+=o;if(m<k){o=d[2]-c;if(o<0){o=-o}m+=o;if(m<k){k=m;e=f}}f--}}}return e};a.prototype.getColorCount=function(){return this.netsize};a.prototype.getColorMap=function(){var j,d,c,k,h,e,f;k=[];j=this.netsize;for(e=0;(0<=j?e<j:e>j);(0<=j?e+=1:e-=1)){c=this.colormap[e][0];h=this.colormap[e][1];f=this.colormap[e][2];d=255;k[e]=(d<<24)|(f<<16)|(h<<8)|(c)}return k};root.NeuQuant=a}).call(this);