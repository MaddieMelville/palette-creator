var NeuQuant,log,onmessage;var __slice=Array.prototype.slice;onmessage=function(a){var b,c;b=a.data;switch(b.type){case"quantize":c=new NeuQuant(b.pixels,b.sample,b.colors);c.init();c.convertPixels(b.pixels);return postMessage({type:"palette",palette:c.getColorMap()})}};log=function(a){return postMessage({type:"log",message:a})};NeuQuant=function(h,d,g){var f,a,e,c,b;b=h.length>>2;this.prime1=499;this.prime2=491;this.prime3=487;this.prime4=503;this.maxprime=this.prime4;if(b<this.maxprime){throw"Image is too small"}if((function(){for(var j=0,i=(e=(function(){c=[];for(j=1;j<=30;j++){c.push(j)}return c}).call(this)).length;j<i;j++){if(e[j]===!d){return true}}return false}).call(this)){throw"Sample must be 1..30"}if((function(){for(var j=0,i=(e=(function(){c=[];for(j=4;j<=256;j++){c.push(j)}return c}).call(this)).length;j<i;j++){if(e[j]===!g){return true}}return false}).call(this)){throw"Color count must be 4..256"}this.ncycles=100;this.pixels=h;this.sample=d;this.netsize=g;this.specials=1;this.bgcolor=this.specials-1;this.cutnetsize=this.netsize-this.specials;this.maxnetpos=this.netsize-1;this.initradius=Math.floor(this.netsize/8);this.radiusbiasshift=6;this.radiusbias=1<<this.radiusbiasshift;this.initbiasradius=this.initradius*this.radiusbias;this.radiusdec=30;this.alphabiasshift=10;this.initalpha=1<<this.alphabiasshift;this.gamma=1024;this.beta=1/1024;this.betagamma=this.beta*this.gamma;this.setupArrays();return this};NeuQuant.prototype.setupArrays=function(){var b,d,a,c;this.network=this.createArray(0,this.netsize,3);this.colormap=this.createArray(0,this.netsize,4);this.netindex=this.createArray(0,256);this.bias=this.createArray(0,this.netsize);this.freq=this.createArray(0,this.netsize);this.network[0][0]=0;this.network[0][1]=0;this.network[0][2]=0;this.network[1][0]=255;this.network[1][1]=255;this.network[1][2]=255;b=this.specials;for(a=0;(0<=b?a<b:a>b);(0<=b?a+=1:a-=1)){this.freq[a]=1/this.netsize;this.bias[a]=0}b=this.specials;d=this.netsize;for(a=b;(b<=d?a<d:a>d);(b<=d?a+=1:a-=1)){c=this.network[a];c[0]=(255*(a-this.specials))/this.cutnetsize;c[1]=(255*(a-this.specials))/this.cutnetsize;c[2]=(255*(a-this.specials))/this.cutnetsize;this.freq[a]=1/this.netsize;this.bias[a]=0}return this};NeuQuant.prototype.createArray=function(g){var f,c,a,e,d,b;e=__slice.call(arguments,1);if(!(e!=null)||e.length===0){return g}a=new Array(e.shift());b=arguments.callee;c=[g].concat(e);f=a.length;for(d=0;(0<=f?d<f:d>f);(0<=f?d+=1:d-=1)){a[d]=b.apply(this,c)}return a};NeuQuant.prototype.init=function(){this.learn();this.fix();this.build();return this};NeuQuant.prototype.learn=function(){var u,f,l,s,e,v,n,m,k,o,q,c,p,h,d,w;e=this.initbiasradius;l=30+Math.floor((this.sample-1)/3);o=this.pixels.length>>2;h=Math.floor(o/this.sample);v=Math.floor(h/this.ncycles);f=this.initalpha;p=e>>this.radiusbiasshift;if(p<=1){p=0}log("Beginning 1D learning: sample pixels = "+h+"; radius = "+p);d=0;q=0;if(o%this.prime1!==0){d=this.prime1}else{if(o%this.prime2!==0){d=this.prime2}else{if(o%this.prime3!==0){d=this.prime3}else{d=this.prime4}}}m=0;while(m<h){w=q<<2;c=this.pixels[w];n=this.pixels[w+1];s=this.pixels[w+2];k=this.specialFind(s,n,c);k=k<0?this.contest(s,n,c):k;if(k>=this.specials){u=f/this.initalpha;this.alterSingle(u,k,s,n,c);if(p>0){this.alterNeighbors(u,p,k,s,n,c)}}q+=d;while(q>=o){q-=o}m++;if(m%v===0){f-=Math.floor(f/l);e-=Math.floor(e/this.radiusdec);p=e>>this.radiusbiasshift;if(p<=1){p=0}}}log("Finished 1D learning: final alpha = "+(f/this.initalpha));return this};NeuQuant.prototype.fix=function(){var d,c,b,a;d=this.netsize;for(c=0;(0<=d?c<d:c>d);(0<=d?c+=1:c-=1)){for(b=0;b<3;b++){a=Math.floor(0.5+this.network[c][b]);if(a<0){a=0}else{if(a>255){a=255}}this.colormap[c][b]=a}this.colormap[c][3]=c}return this};NeuQuant.prototype.build=function(){var h,e,d,k,g,c,a,b,f,m,l;a=0;l=0;h=this.netsize;for(k=0;(0<=h?k<h:k>h);(0<=h?k+=1:k-=1)){c=this.colormap[k];b=null;f=k;m=c[1];e=k+1;d=this.netsize;for(g=e;(e<=d?g<d:g>d);(e<=d?g+=1:g-=1)){b=this.colormap[g];if(b[1]<m){f=g;m=b[1]}}b=this.colormap[f];if(k!==f){e=[b[0],c[0]],c[0]=e[0],b[0]=e[1];e=[b[1],c[1]],c[1]=e[0],b[1]=e[1];e=[b[2],c[2]],c[2]=e[0],b[2]=e[1];e=[b[3],c[3]],c[3]=e[0],b[3]=e[1]}if(m!==a){this.netindex[a]=(l+k)>>1;e=a+1;for(g=e;(e<=m?g<m:g>m);(e<=m?g+=1:g-=1)){this.netindex[g]=k}a=m;l=k}}this.netindex[a]=(l+this.maxnetpos)>>1;h=a+1;for(g=h;(h<=256?g<256:g>256);(h<=256?g+=1:g-=1)){this.netindex[g]=this.maxnetpos}return this};NeuQuant.prototype.alterSingle=function(f,c,a,e,d){var h;h=this.network[c];h[0]-=(f*(h[0]-a));h[1]-=(f*(h[1]-e));h[2]-=(f*(h[2]-d));return this};NeuQuant.prototype.alterNeighbors=function(l,t,n,u,o,c){var v,f,m,h,s,e,d;s=n-t;if(s<this.specials-1){s=this.specials-1}f=n+t;if(f>this.netsize){f=this.netsize}m=n+1;h=n-1;d=0;while(m<f||h>s){v=(l*(t*t-d*d))/(t*t);d++;if(m<f){e=this.network[m];e[0]-=(v*(e[0]-u));e[1]-=(v*(e[1]-o));e[2]-=(v*(e[2]-c));m++}if(h>s){e=this.network[h];e[0]-=(v*(e[0]-u));e[1]-=(v*(e[1]-o));e[2]-=(v*(e[2]-c));h--}}return this};NeuQuant.prototype.specialFind=function(a,e,d){var f,c,h;f=this.specials;for(c=0;(0<=f?c<f:c>f);(0<=f?c+=1:c-=1)){h=this.network[c];if(h[0]===a&&h[1]===e&&h[2]===d){return c}}return -1};NeuQuant.prototype.contest=function(q,m,d){var k,f,s,c,o,j,l,t,p,h,e;j=Number.MAX_VALUE;c=j;l=-1;o=l;k=this.specials;f=this.netsize;for(h=k;(k<=f?h<f:h>f);(k<=f?h+=1:h-=1)){e=this.network[h];p=e[0]-q;if(p<0){p=-p}s=e[1]-m;if(s<0){s=-s}p+=s;s=e[2]-d;if(s<0){s=-s}p+=s;if(p<j){j=p;l=h}t=p-this.bias[h];if(t<c){c=t;o=h}this.freq[h]-=this.beta*this.freq[h];this.bias[h]+=this.betagamma*this.freq[h]}this.freq[l]+=this.beta;this.bias[l]-=this.betagamma;return o};NeuQuant.prototype.convertPixels=function(d){var k,j,f,e,h,i,c,m;h=d.length>>2;for(e=0;(0<=h?e<h:e>h);(0<=h?e+=1:e-=1)){m=e<<2;c=d[m];f=d[m+1];j=d[m+2];k=d[m+3];i=this.convertPixel(k,c,f,j);d[m]=i[0];d[m+1]=i[1];d[m+2]=i[2];d[m+3]=i[3]}return d};NeuQuant.prototype.convertPixel=function(e){var d,c,h,f;d=(e>>24)&255;f=(e>>16)&255;h=(e>>8)&255;c=(e)&255;return this.convertPixel(d,f,h,c)};NeuQuant.prototype.convertPixel=function(d,h,f,c){var e;e=this.search(c,f,h);c=this.colormap[e][0];f=this.colormap[e][1];h=this.colormap[e][2];return[h,f,c,d]};NeuQuant.prototype.search=function(n,l,c){var o,e,k,m,h,f,d;k=1000;e=-1;h=this.netindex[l];f=h-1;while(h<this.netsize||(f>=0)){if(h<this.netsize){d=this.colormap[h];m=d[1]-l;if(m>=k){h=this.netsize}else{if(m<0){m=-m}o=d[0]-n;if(o<0){o=-o}m+=o;if(m<k){o=d[2]-c;if(o<0){o=-o}m+=o;if(m<k){k=m;e=h}}h++}}if(f>=0){d=this.colormap[f];m=l-d[1];if(m>=k){f=-1}else{if(m<0){m=-m}o=d[0]-n;if(o<0){o=-o}m+=o;if(m<k){o=d[2]-c;if(o<0){o=-o}m+=o;if(m<k){k=m;e=f}}f--}}}return e};NeuQuant.prototype.getColorCount=function(){return this.netsize};NeuQuant.prototype.getColorMap=function(){var j,d,c,k,h,e,f;k=[];j=this.netsize;for(e=0;(0<=j?e<j:e>j);(0<=j?e+=1:e-=1)){c=this.colormap[e][0];h=this.colormap[e][1];f=this.colormap[e][2];d=255;k.push(f);k.push(h);k.push(c);k.push(d)}return k};