(function(){var g,c,e,h,j,i,a,m,k,b,d,f,l;({root:(typeof exports!=="undefined"&&exports!==null)?exports:this});a=true;e=255;c=266817;h=8;k=(function(){f=[];d=-e;for(l=d;(d<=e?l<=e:l>=e);(d<=e?l+=1:l-=1)){f.push(l*l)}return f})();m=(function(){f=[];for(l=0;(0<=h?l<=h:l>=h);(0<=h?l+=1:l-=1)){f.push(1<<(15-l))}return f})();i=function(){return this};i.prototype.quantizeImage=function(u,r){var t,p,s,n,q,o;n=new g(u,r);n.classification();n.reduction();n.assignment();o=[];s=n.colormap;t=s.length-1;for(q=0;(0<=t?q<=t:q>=t);(0<=t?q+=1:q-=1)){p=s[q];o.push((p>>16)&255);o.push((p>>8)&255);o.push((p>>0)&255);o.push(255)}return o};g=function(o,n){this.pixels=o;this.max_colors=n;this.colormap=null;this.root=null;this.depth=0;this.colors=0;this.nodes=0;this.depth=Math.floor(Math.log(n)/Math.log(4))+1;if(this.depth>h){this.depth=h}else{if(this.depth<2){this.depth=2}}this.root=new j(this);return this};g.prototype.classification=function(){var s,q,x,u,v,o,t,w,n,p,r;w=Math.floor(this.pixels.length/4);s=w-1;for(t=0;(0<=s?t<=s:t>=s);(0<=s?t+=1:t-=1)){v=t<<2;r=this.pixels[v];u=this.pixels[v+1];x=this.pixels[v+2];if(this.nodes>c){this.root.pruneLevel();this.depth--}p=this.root;q=this.depth;for(n=1;(1<=q?n<=q:n>=q);(1<=q?n+=1:n-=1)){o=(((r>p.mid_red?1:0)<<0)|((u>p.mid_green?1:0)<<1)|((x>p.mid_blue?1:0)<<2));if(!(p.child[o]!=null)){new j(p,o,n)}p=p.child[o];p.number_pixels+=m[n]}p.unique++;p.total_red+=r;p.total_green+=u;p.total_blue+=x}return this};g.prototype.reduction=function(){var n;n=1;while(this.colors>this.max_colors){this.colors=0;n=this.root.reduce(n,Number.MAX_VALUE)}return this};g.prototype.assignment=function(){var r,w,t,u,o,s,v,p,n,q,x;this.colormap=[];this.colors=0;this.root.colormap();x=new b();v=this.pixels.length;r=v-1;for(s=0;(0<=r?s<=r:s>=r);(0<=r?s+=1:s-=1)){u=s<<2;q=this.pixels[u];t=this.pixels[u+1];w=this.pixels[u+2];p=this.root;while(true){o=(((q>p.mid_red?1:0)<<0)|((t>p.mid_green?1:0)<<1)|((w>p.mid_blue?1:0)<<2));if(!(p.child[o]!=null)){break}p=p.child[o]}if(a){n=p.color_number}else{x.distance=Number.MAX_VALUE;p.parent.closestColor(q,t,w,x);n=x.color_number}this.pixels[u]=(n>>16)&255;this.pixels[u+1]=(n>>8)&255;this.pixels[u+2]=(n>>0)&255}return this};b=function(){this.distance=0;this.color_number=0;return this};j=function(o,q,p){var n;this.cube=null;this.parent=null;this.child=null;this.nchild=0;this.id=0;this.level=0;this.mid_red=0;this.mid_green=0;this.mid_blue=0;this.number_pixels=0;this.unique=0;this.total_red=0;this.total_green=0;this.total_blue=0;this.color_number=0;if(!(q!=null)||!(p!=null)){this.cube=o;this.parent=this;this.child=[];this.id=0;this.level=0;this.number_pixels=Number.MAX_VALUE;this.mid_red=(e+1)>>1;this.mid_green=(e+1)>>1;this.mid_blue=(e+1)>>1}else{this.cube=o.cube;this.parent=o;this.child=[];this.id=q;this.level=p;this.cube.nodes++;if(this.level===this.cube.depth){this.cube.colors++}this.parent.nchild++;this.parent.child[this.id]=this;n=(1<<(h-p))>>1;this.mid_red=this.parent.mid_red+((this.id&1)>(0!=null)?0:{bi:-n});this.mid_green=this.parent.mid_green+((this.id&2)>(0!=null)?0:{bi:-n});this.mid_blue=this.parent.mid_blue+((this.id&4)>(0!=null)?0:{bi:-n})}return this};j.prototype.pruneChild=function(){this.parent.nchild--;this.parent.unique+=this.unique;this.parent.total_red+=this.total_red;this.parent.total_green+=this.total_green;this.parent.total_blue+=this.total_blue;this.parent.child[this.id]=null;this.cube.nodes--;this.cube=null;this.parent=null;return this};j.prototype.pruneLevel=function(){var n;if(this.nchild!==0){for(n=0;n<=7;n++){if(this.child[n]!=null){this.child[n].pruneLevel()}}}if(this.level===this.cube.depth){this.pruneChild()}return this};j.prototype.reduce=function(n,o){var p;if(this.nchild!==0){for(p=0;p<=7;p++){if(this.child[p]!=null){o=this.child[p].reduce(n,o)}}}if(this.number_pixels<=n){this.pruneChild()}else{if(this.unique!==0){this.cube.colors++}if(this.number_pixels<o){o=this.number_pixels}}return o};j.prototype.colormap=function(){var n,o,q,p;if(this.nchild!==0){for(q=0;q<=7;q++){if(this.child[q]!=null){this.child[q].colormap()}}}if(this.unique!==0){p=((this.total_red+(this.unique>>1))/this.unique);o=((this.total_green+(this.unique>>1))/this.unique);n=((this.total_blue+(this.unique>>1))/this.unique);this.cube.colormap[this.cube.colors]=(((255)<<24)|((p&255)<<16)|((o&255)<<8)|((n&255)<<0));this.color_number=this.cube.colors++}return this};j.prototype.closestColor=function(r,q,n,p){var o,t,s;if(this.nchild!==0){for(s=0;s<=7;s++){if(this.child[s]!=null){this.child[s].closestColor(r,q,n,p)}}if(this.unique!==0){o=this.cube.colormap[this.color_number];t=this.distance(o,r,q,n);if(t<p.distance){p.distance=t;p.color_number=this.color_number}}}return this};j.prototype.distance=function(o,q,p,n){return k[((o>>16)&255)-q+e]+k[((o>>8)&255)-p+e]+k[((o>>0)&255)-n+e]};root.OctreeQuant=i}).call(this);