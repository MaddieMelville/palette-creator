((function(){var a,b,c,d,e,f,g,h,i,j,k;({root:typeof exports!="undefined"&&exports!==null?exports:this}),g=!0,c=255,b=266817,d=8;for(k=-c;-c<=c?k<=c:k>=c;-c<=c?k++:k--)i=k*k;for(k=0;0<=d?k<=d:k>=d;0<=d?k++:k--)h=1<<15-k;f=function(){function b(){}return b.prototype.quantizeImage=function(b,c){var d;return d=new a(b,c),d.classification(),d.reduction(),d.assignment(),d.colormap},b}(),a=function(){function a(a,b){this.pixels=a,this.max_colors=b,this.colormap=null,this.root=null,this.depth=0,this.colors=0,this.nodes=0,this.depth=Math.floor(Math.log(b)/Math.log(4))+1,this.depth>d?this.depth=d:this.depth<2&&(this.depth=2),this.root=new e(this)}return a.prototype.classification=function(){var a,c,d,f,g,i,j,k,l,m,n,o,p,q;l=this.pixels.length,d=this.pixels[0].length;for(m=o=l-1;o<=0?m<=0:m>=0;o<=0?m++:m--)for(n=p=d-1;p<=0?n<=0:n>=0;p<=0?n++:n--){j=this.pixels[m][n],k=j>>16&255,c=j>>8&255,a=j>>0&255,this.nodes>b&&(this.root.pruneLevel(),this.depth--),i=this.root;for(g=1,q=this.depth;1<=q?g<=q:g>=q;1<=q?g++:g--)f=(k>i.mid_red?1:0)<<0|(c>i.mid_green?1:0)<<1|(a>i.mid_blue?1:0)<<2,i.child[f]==null&&new e(i,f,g),i=i.child[f],i.number_pixels+=h[g];i.unique++,i.total_red+=k,i.total_green+=c,i.total_blue+=a}return this},a.prototype.reduction=function(){var a;a=1;while(this.colors>this.max_colors)this.colors=0,a=this.root.reduce(a,Number.MAX_VALUE);return this},a.prototype.assignment=function(){var a,b,c,d,e,f,h,i,k,l,m,n,o;this.colormap=[],this.colors=0,this.root.colormap(),k=this.pixels.length,c=this.pixels[0].length,i=new j;for(l=n=k-1;n<=0?l<=0:l>=0;n<=0?l++:l--)for(m=o=c-1;o<=0?m<=0:m>=0;o<=0?m++:m--){f=this.pixels[l][m],h=f>>16&255,b=f>>8&255,a=f>>0&255,e=this.root;for(;;){d=(h>e.mid_red?1:0)<<0|(b>e.mid_green?1:0)<<1|(a>e.mid_blue?1:0)<<2;if(e.child[d]==null)break;e=e.child[d]}g?this.pixels[l][m]=e.color_number:(i.distance=Number.MAX_VALUE,e.parent.closestColor(h,b,a,i),this.pixels[l][m]=i.color_number)}return this},a}(),j=function(){function a(){this.distance=0,this.color_number=0}return a}(),e=function(){function a(a,b,e){var f,g,h,i;this.cube=null,this.parent=null,this.child=null,this.nchild=0,this.id=0,this.level=0,this.mid_red=0,this.mid_green=0,this.mid_blue=0,this.number_pixels=0,this.unique=0,this.total_red=0,this.total_green=0,this.total_blue=0,this.color_number=0,b==null||e==null?(this.cube=a,this.parent=this,this.child=[],this.id=0,this.level=0,this.number_pixels=Number.MAX_VALUE,this.mid_red=c+1>>1,this.mid_green=c+1>>1,this.mid_blue=c+1>>1):(this.cube=a.cube,this.parent=a,this.child=[],this.id=b,this.level=e,this.cube.nodes++,this.level===this.cube.depth&&this.cube.colors++,this.parent.nchild++,this.parent.child[this.id]=this,f=1<<d-e>>1,this.mid_red=this.parent.mid_red+((g=(this.id&1)>0)!=null?g:{bi:-f}),this.mid_green=this.parent.mid_green+((h=(this.id&2)>0)!=null?h:{bi:-f}),this.mid_blue=this.parent.mid_blue+((i=(this.id&4)>0)!=null?i:{bi:-f}))}return a.prototype.pruneChild=function(){return this.parent.nchild--,this.parent.unique+=this.unique,this.parent.total_red+=this.total_red,this.parent.total_green+=this.total_green,this.parent.total_blue+=this.total_blue,this.parent.child[this.id]=null,this.cube.nodes--,this.cube=null,this.parent=null,this},a.prototype.pruneLevel=function(){var a;if(this.nchild!==0)for(a=0;a<=7;a++)this.child[a]!=null&&this.child[a].pruneLevel();return this.level===this.cube.depth&&this.pruneChild(),this},a.prototype.reduce=function(a,b){var c;if(this.nchild!==0)for(c=0;c<=7;c++)this.child[c]!=null&&(b=this.child[c].reduce(a,b));return this.number_pixels<=a?this.pruneChild():(this.unique!==0&&this.cube.colors++,this.number_pixels<b&&(b=this.number_pixels)),b},a.prototype.colormap=function(){var a,b,c,d;if(this.nchild!==0)for(c=0;c<=7;c++)this.child[c]!=null&&this.child[c].colormap();return this.unique!==0&&(d=(this.total_red+(this.unique>>1))/this.unique,b=(this.total_green+(this.unique>>1))/this.unique,a=(this.total_blue+(this.unique>>1))/this.unique,this.cube.colormap[this.cube.colors]=255<<24|(d&255)<<16|(b&255)<<8|(a&255)<<0,this.color_number=this.cube.colors++),this},a.prototype.closestColor=function(a,b,c,d){var e,f,g;if(this.nchild!==0){for(g=0;g<=7;g++)this.child[g]!=null&&this.child[g].closestColor(a,b,c,d);this.unique!==0&&(e=this.cube.colormap[this.color_number],f=this.distance(e,a,b,c),f<d.distance&&(d.distance=f,d.color_number=this.color_number))}return this},a.prototype.distance=function(a,b,d,e){return i[(a>>16&255)-b+c]+i[(a>>8&255)-d+c]+i[(a>>0&255)-e+c]},a}(),root.OctreeQuant=f})).call(this);