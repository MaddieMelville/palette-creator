(function(){var Cube,MAX_NODES,MAX_RGB,MAX_TREE_DEPTH,Node,OctreeQuant,QUICK,SHIFT,SQUARES,Search,x,_i,_j;({root:typeof exports!=="undefined"&&exports!==null?exports:this});QUICK=true;MAX_RGB=255;MAX_NODES=266817;MAX_TREE_DEPTH=8;for(x=_i=-MAX_RGB;-MAX_RGB<=MAX_RGB?_i<=MAX_RGB:_i>=MAX_RGB;x=-MAX_RGB<=MAX_RGB?++_i:--_i){SQUARES=x*x}for(x=_j=0;0<=MAX_TREE_DEPTH?_j<=MAX_TREE_DEPTH:_j>=MAX_TREE_DEPTH;x=0<=MAX_TREE_DEPTH?++_j:--_j){SHIFT=1<<15-x}OctreeQuant=function(){function OctreeQuant(){}OctreeQuant.prototype.quantizeImage=function(pixels,max_colors){var cube;cube=new Cube(pixels,max_colors);cube.classification();cube.reduction();cube.assignment();return cube.colormap};return OctreeQuant}();Cube=function(){function Cube(pixels,max_colors){this.pixels=pixels;this.max_colors=max_colors;this.colormap=null;this.root=null;this.depth=0;this.colors=0;this.nodes=0;this.depth=Math.floor(Math.log(max_colors)/Math.log(4))+1;if(this.depth>MAX_TREE_DEPTH){this.depth=MAX_TREE_DEPTH}else if(this.depth<2){this.depth=2}this.root=new Node(this)}Cube.prototype.classification=function(){var blue,green,height,id,level,node,pixel,red,width,y,_k,_l,_m,_ref,_ref1,_ref2;width=this.pixels.length;height=this.pixels[0].length;for(x=_k=_ref=width-1;_ref<=0?_k<=0:_k>=0;x=_ref<=0?++_k:--_k){for(y=_l=_ref1=height-1;_ref1<=0?_l<=0:_l>=0;y=_ref1<=0?++_l:--_l){pixel=this.pixels[x][y];red=pixel>>16&255;green=pixel>>8&255;blue=pixel>>0&255;if(this.nodes>MAX_NODES){this.root.pruneLevel();this.depth--}node=this.root;for(level=_m=1,_ref2=this.depth;1<=_ref2?_m<=_ref2:_m>=_ref2;level=1<=_ref2?++_m:--_m){id=(red>node.mid_red?1:0)<<0|(green>node.mid_green?1:0)<<1|(blue>node.mid_blue?1:0)<<2;if(!(node.child[id]!=null)){new Node(node,id,level)}node=node.child[id];node.number_pixels+=SHIFT[level]}node.unique++;node.total_red+=red;node.total_green+=green;node.total_blue+=blue}}return this};Cube.prototype.reduction=function(){var threshold;threshold=1;while(this.colors>this.max_colors){this.colors=0;threshold=this.root.reduce(threshold,Number.MAX_VALUE)}return this};Cube.prototype.assignment=function(){var blue,green,height,id,node,pixel,red,search,width,y,_k,_l,_ref,_ref1;this.colormap=[];this.colors=0;this.root.colormap();width=this.pixels.length;height=this.pixels[0].length;search=new Search;for(x=_k=_ref=width-1;_ref<=0?_k<=0:_k>=0;x=_ref<=0?++_k:--_k){for(y=_l=_ref1=height-1;_ref1<=0?_l<=0:_l>=0;y=_ref1<=0?++_l:--_l){pixel=this.pixels[x][y];red=pixel>>16&255;green=pixel>>8&255;blue=pixel>>0&255;node=this.root;while(true){id=(red>node.mid_red?1:0)<<0|(green>node.mid_green?1:0)<<1|(blue>node.mid_blue?1:0)<<2;if(!(node.child[id]!=null)){break}node=node.child[id]}if(QUICK){this.pixels[x][y]=node.color_number}else{search.distance=Number.MAX_VALUE;node.parent.closestColor(red,green,blue,search);this.pixels[x][y]=search.color_number}}}return this};return Cube}();Search=function(){function Search(){this.distance=0;this.color_number=0}return Search}();Node=function(){function Node(parent,id,level){var bi,_ref,_ref1,_ref2;this.cube=null;this.parent=null;this.child=null;this.nchild=0;this.id=0;this.level=0;this.mid_red=0;this.mid_green=0;this.mid_blue=0;this.number_pixels=0;this.unique=0;this.total_red=0;this.total_green=0;this.total_blue=0;this.color_number=0;if(!(id!=null)||!(level!=null)){this.cube=parent;this.parent=this;this.child=[];this.id=0;this.level=0;this.number_pixels=Number.MAX_VALUE;this.mid_red=MAX_RGB+1>>1;this.mid_green=MAX_RGB+1>>1;this.mid_blue=MAX_RGB+1>>1}else{this.cube=parent.cube;this.parent=parent;this.child=[];this.id=id;this.level=level;this.cube.nodes++;if(this.level===this.cube.depth){this.cube.colors++}this.parent.nchild++;this.parent.child[this.id]=this;bi=1<<MAX_TREE_DEPTH-level>>1;this.mid_red=this.parent.mid_red+((_ref=(this.id&1)>0)!=null?_ref:{bi:-bi});this.mid_green=this.parent.mid_green+((_ref1=(this.id&2)>0)!=null?_ref1:{bi:-bi});this.mid_blue=this.parent.mid_blue+((_ref2=(this.id&4)>0)!=null?_ref2:{bi:-bi})}}Node.prototype.pruneChild=function(){this.parent.nchild--;this.parent.unique+=this.unique;this.parent.total_red+=this.total_red;this.parent.total_green+=this.total_green;this.parent.total_blue+=this.total_blue;this.parent.child[this.id]=null;this.cube.nodes--;this.cube=null;this.parent=null;return this};Node.prototype.pruneLevel=function(){var id,_k;if(this.nchild!==0){for(id=_k=0;_k<=7;id=++_k){if(this.child[id]!=null){this.child[id].pruneLevel()}}}if(this.level===this.cube.depth){this.pruneChild()}return this};Node.prototype.reduce=function(threshold,next_threshold){var id,_k;if(this.nchild!==0){for(id=_k=0;_k<=7;id=++_k){if(this.child[id]!=null){next_threshold=this.child[id].reduce(threshold,next_threshold)}}}if(this.number_pixels<=threshold){this.pruneChild()}else{if(this.unique!==0){this.cube.colors++}if(this.number_pixels<next_threshold){next_threshold=this.number_pixels}}return next_threshold};Node.prototype.colormap=function(){var blue,green,id,red,_k;if(this.nchild!==0){for(id=_k=0;_k<=7;id=++_k){if(this.child[id]!=null){this.child[id].colormap()}}}if(this.unique!==0){red=(this.total_red+(this.unique>>1))/this.unique;green=(this.total_green+(this.unique>>1))/this.unique;blue=(this.total_blue+(this.unique>>1))/this.unique;this.cube.colormap[this.cube.colors]=255<<24|(red&255)<<16|(green&255)<<8|(blue&255)<<0;this.color_number=this.cube.colors++}return this};Node.prototype.closestColor=function(red,green,blue,search){var color,distance,id,_k;if(this.nchild!==0){for(id=_k=0;_k<=7;id=++_k){if(this.child[id]!=null){this.child[id].closestColor(red,green,blue,search)}}if(this.unique!==0){color=this.cube.colormap[this.color_number];distance=this.distance(color,red,green,blue);if(distance<search.distance){search.distance=distance;search.color_number=this.color_number}}}return this};Node.prototype.distance=function(color,red,green,blue){return SQUARES[(color>>16&255)-red+MAX_RGB]+SQUARES[(color>>8&255)-green+MAX_RGB]+SQUARES[(color>>0&255)-blue+MAX_RGB]};return Node}();root.OctreeQuant=OctreeQuant}).call(this);