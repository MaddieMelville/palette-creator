(function(){var g,c,e,h,j,i,a,m,k,b,d,f,l;({root:(typeof exports!=="undefined"&&exports!==null)?exports:this});a=true;e=255;c=266817;h=8;k=(function(){f=[];d=-e;for(l=d;(d<=e?l<=e:l>=e);(d<=e?l+=1:l-=1)){f.push(l*l)}return f})();m=(function(){f=[];for(l=0;(0<=h?l<=h:l>=h);(0<=h?l+=1:l-=1)){f.push(1<<(15-l))}return f})();i=function(){return this};i.prototype.quantizeImage=function(p,o){var n;n=new g(p,o);n.classification();n.reduction();n.assignment();return n.colormap};g=function(o,n){this.pixels=o;this.max_colors=n;this.colormap=null;this.root=null;this.depth=0;this.colors=0;this.nodes=0;this.depth=Math.floor(Math.log(n)/Math.log(4))+1;if(this.depth>h){this.depth=h}else{if(this.depth<2){this.depth=2}}this.root=new j(this);return this};g.prototype.classification=function(){var v,t,r,B,w,C,q,n,s,p,u,o,A,z;o=this.pixels.length;C=this.pixels[0].length;v=o-1;for(A=v;(v<=0?A<=0:A>=0);(v<=0?A+=1:A-=1)){t=C-1;for(z=t;(t<=0?z<=0:z>=0);(t<=0?z+=1:z-=1)){p=this.pixels[A][z];u=(p>>16)&255;w=(p>>8)&255;B=(p>>0)&255;if(this.nodes>c){this.root.pruneLevel();this.depth--}s=this.root;r=this.depth;for(n=1;(1<=r?n<=r:n>=r);(1<=r?n+=1:n-=1)){q=(((u>s.mid_red?1:0)<<0)|((w>s.mid_green?1:0)<<1)|((B>s.mid_blue?1:0)<<2));if(!(s.child[q]!=null)){new j(s,q,n)}s=s.child[q];s.number_pixels+=m[n]}s.unique++;s.total_red+=u;s.total_green+=w;s.total_blue+=B}}return this};g.prototype.reduction=function(){var n;n=1;while(this.colors>this.max_colors){this.colors=0;n=this.root.reduce(n,Number.MAX_VALUE)}return this};g.prototype.assignment=function(){var t,q,z,u,A,o,r,p,s,B,n,w,v;this.colormap=[];this.colors=0;this.root.colormap();n=this.pixels.length;A=this.pixels[0].length;B=new b();t=n-1;for(w=t;(t<=0?w<=0:w>=0);(t<=0?w+=1:w-=1)){q=A-1;for(v=q;(q<=0?v<=0:v>=0);(q<=0?v+=1:v-=1)){p=this.pixels[w][v];s=(p>>16)&255;u=(p>>8)&255;z=(p>>0)&255;r=this.root;while(true){o=(((s>r.mid_red?1:0)<<0)|((u>r.mid_green?1:0)<<1)|((z>r.mid_blue?1:0)<<2));if(!(r.child[o]!=null)){break}r=r.child[o]}if(a){this.pixels[w][v]=r.color_number}else{B.distance=Number.MAX_VALUE;r.parent.closestColor(s,u,z,B);this.pixels[w][v]=B.color_number}}}return this};b=function(){this.distance=0;this.color_number=0;return this};j=function(o,q,p){var n;this.cube=null;this.parent=null;this.child=null;this.nchild=0;this.id=0;this.level=0;this.mid_red=0;this.mid_green=0;this.mid_blue=0;this.number_pixels=0;this.unique=0;this.total_red=0;this.total_green=0;this.total_blue=0;this.color_number=0;if(!(q!=null)||!(p!=null)){this.cube=o;this.parent=this;this.child=[];this.id=0;this.level=0;this.number_pixels=Number.MAX_VALUE;this.mid_red=(e+1)>>1;this.mid_green=(e+1)>>1;this.mid_blue=(e+1)>>1}else{this.cube=o.cube;this.parent=o;this.child=[];this.id=q;this.level=p;this.cube.nodes++;if(this.level===this.cube.depth){this.cube.colors++}this.parent.nchild++;this.parent.child[this.id]=this;n=(1<<(h-p))>>1;this.mid_red=this.parent.mid_red+((this.id&1)>(0!=null)?0:{bi:-n});this.mid_green=this.parent.mid_green+((this.id&2)>(0!=null)?0:{bi:-n});this.mid_blue=this.parent.mid_blue+((this.id&4)>(0!=null)?0:{bi:-n})}return this};j.prototype.pruneChild=function(){this.parent.nchild--;this.parent.unique+=this.unique;this.parent.total_red+=this.total_red;this.parent.total_green+=this.total_green;this.parent.total_blue+=this.total_blue;this.parent.child[this.id]=null;this.cube.nodes--;this.cube=null;this.parent=null;return this};j.prototype.pruneLevel=function(){var n;if(this.nchild!==0){for(n=0;n<=7;n++){if(this.child[n]!=null){this.child[n].pruneLevel()}}}if(this.level===this.cube.depth){this.pruneChild()}return this};j.prototype.reduce=function(n,o){var p;if(this.nchild!==0){for(p=0;p<=7;p++){if(this.child[p]!=null){o=this.child[p].reduce(n,o)}}}if(this.number_pixels<=n){this.pruneChild()}else{if(this.unique!==0){this.cube.colors++}if(this.number_pixels<o){o=this.number_pixels}}return o};j.prototype.colormap=function(){var n,o,q,p;if(this.nchild!==0){for(q=0;q<=7;q++){if(this.child[q]!=null){this.child[q].colormap()}}}if(this.unique!==0){p=((this.total_red+(this.unique>>1))/this.unique);o=((this.total_green+(this.unique>>1))/this.unique);n=((this.total_blue+(this.unique>>1))/this.unique);this.cube.colormap[this.cube.colors]=(((255)<<24)|((p&255)<<16)|((o&255)<<8)|((n&255)<<0));this.color_number=this.cube.colors++}return this};j.prototype.closestColor=function(r,q,n,p){var o,t,s;if(this.nchild!==0){for(s=0;s<=7;s++){if(this.child[s]!=null){this.child[s].closestColor(r,q,n,p)}}if(this.unique!==0){o=this.cube.colormap[this.color_number];t=this.distance(o,r,q,n);if(t<p.distance){p.distance=t;p.color_number=this.color_number}}}return this};j.prototype.distance=function(o,q,p,n){return k[((o>>16)&255)-q+e]+k[((o>>8)&255)-p+e]+k[((o>>0)&255)-n+e]};root.OctreeQuant=i}).call(this);