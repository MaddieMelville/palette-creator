var Cube,MAX_NODES,MAX_RGB,MAX_TREE_DEPTH,Node,OctreeQuant,QUICK,SHIFT,SQUARES,Search,log,onmessage,x;onmessage=function(a){var b,c,d;b=a.data;if(b.type==="quantize")return d=new OctreeQuant,c=d.quantizeImage(b.pixels,b.colors),postMessage({type:"palette",palette:c})},log=function(a){return postMessage({type:"log",message:a})},QUICK=!0,MAX_RGB=255,MAX_NODES=266817,MAX_TREE_DEPTH=8;for(x=-MAX_RGB;-MAX_RGB<=MAX_RGB?x<=MAX_RGB:x>=MAX_RGB;-MAX_RGB<=MAX_RGB?x++:x--)SQUARES=x*x;for(x=0;0<=MAX_TREE_DEPTH?x<=MAX_TREE_DEPTH:x>=MAX_TREE_DEPTH;0<=MAX_TREE_DEPTH?x++:x--)SHIFT=1<<15-x;OctreeQuant=function(){function a(){}return a.prototype.quantizeImage=function(a,b){var c,d,e,f,g,h;e=new Cube(a,b),e.classification(),e.reduction(),e.assignment(),g=[],d=e.colormap;for(f=0,h=d.length-1;0<=h?f<=h:f>=h;0<=h?f++:f--)c=d[f],g.push(c>>16&255),g.push(c>>8&255),g.push(c>>0&255),g.push(255);return g},a}(),Cube=function(){function a(a,b){this.pixels=a,this.max_colors=b,this.colormap=null,this.root=null,this.depth=0,this.colors=0,this.nodes=0,this.depth=Math.floor(Math.log(b)/Math.log(4))+1,this.depth>MAX_TREE_DEPTH?this.depth=MAX_TREE_DEPTH:this.depth<2&&(this.depth=2),this.root=new Node(this)}return a.prototype.classification=function(){var a,b,c,d,e,f,g,h,i,j,k;f=Math.floor(this.pixels.length/4);for(e=0,j=f-1;0<=j?e<=j:e>=j;0<=j?e++:e--){c=e<<2,i=this.pixels[c],b=this.pixels[c+1],a=this.pixels[c+2],this.nodes>MAX_NODES&&(this.root.pruneLevel(),this.depth--),h=this.root;for(g=1,k=this.depth;1<=k?g<=k:g>=k;1<=k?g++:g--)d=(i>h.mid_red?1:0)<<0|(b>h.mid_green?1:0)<<1|(a>h.mid_blue?1:0)<<2,h.child[d]==null&&new Node(h,d,g),h=h.child[d],h.number_pixels+=SHIFT[g];h.unique++,h.total_red+=i,h.total_green+=b,h.total_blue+=a}return this},a.prototype.reduction=function(){var a;a=1;while(this.colors>this.max_colors)this.colors=0,a=this.root.reduce(a,Number.MAX_VALUE);return this},a.prototype.assignment=function(){var a,b,c,d,e,f,g,h,i,j,k;this.colormap=[],this.colors=0,this.root.colormap(),j=new Search,f=this.pixels.length;for(e=0,k=f-1;0<=k?e<=k:e>=k;0<=k?e++:e--){c=e<<2,i=this.pixels[c],b=this.pixels[c+1],a=this.pixels[c+2],g=this.root;for(;;){d=(i>g.mid_red?1:0)<<0|(b>g.mid_green?1:0)<<1|(a>g.mid_blue?1:0)<<2;if(g.child[d]==null)break;g=g.child[d]}QUICK?h=g.color_number:(j.distance=Number.MAX_VALUE,g.parent.closestColor(i,b,a,j),h=j.color_number),this.pixels[c]=h>>16&255,this.pixels[c+1]=h>>8&255,this.pixels[c+2]=h>>0&255}return this},a}(),Search=function(){function a(){this.distance=0,this.color_number=0}return a}(),Node=function(){function a(a,b,c){var d,e,f,g;this.cube=null,this.parent=null,this.child=null,this.nchild=0,this.id=0,this.level=0,this.mid_red=0,this.mid_green=0,this.mid_blue=0,this.number_pixels=0,this.unique=0,this.total_red=0,this.total_green=0,this.total_blue=0,this.color_number=0,b==null||c==null?(this.cube=a,this.parent=this,this.child=[],this.id=0,this.level=0,this.number_pixels=Number.MAX_VALUE,this.mid_red=MAX_RGB+1>>1,this.mid_green=MAX_RGB+1>>1,this.mid_blue=MAX_RGB+1>>1):(this.cube=a.cube,this.parent=a,this.child=[],this.id=b,this.level=c,this.cube.nodes++,this.level===this.cube.depth&&this.cube.colors++,this.parent.nchild++,this.parent.child[this.id]=this,d=1<<MAX_TREE_DEPTH-c>>1,this.mid_red=this.parent.mid_red+((e=(this.id&1)>0)!=null?e:{bi:-d}),this.mid_green=this.parent.mid_green+((f=(this.id&2)>0)!=null?f:{bi:-d}),this.mid_blue=this.parent.mid_blue+((g=(this.id&4)>0)!=null?g:{bi:-d}))}return a.prototype.pruneChild=function(){return this.parent.nchild--,this.parent.unique+=this.unique,this.parent.total_red+=this.total_red,this.parent.total_green+=this.total_green,this.parent.total_blue+=this.total_blue,this.parent.child[this.id]=null,this.cube.nodes--,this.cube=null,this.parent=null,this},a.prototype.pruneLevel=function(){var a;if(this.nchild!==0)for(a=0;a<=7;a++)this.child[a]!=null&&this.child[a].pruneLevel();return this.level===this.cube.depth&&this.pruneChild(),this},a.prototype.reduce=function(a,b){var c;if(this.nchild!==0)for(c=0;c<=7;c++)this.child[c]!=null&&(b=this.child[c].reduce(a,b));return this.number_pixels<=a?this.pruneChild():(this.unique!==0&&this.cube.colors++,this.number_pixels<b&&(b=this.number_pixels)),b},a.prototype.colormap=function(){var a,b,c,d;if(this.nchild!==0)for(c=0;c<=7;c++)this.child[c]!=null&&this.child[c].colormap();return this.unique!==0&&(d=(this.total_red+(this.unique>>1))/this.unique,b=(this.total_green+(this.unique>>1))/this.unique,a=(this.total_blue+(this.unique>>1))/this.unique,this.cube.colormap[this.cube.colors]=255<<24|(d&255)<<16|(b&255)<<8|(a&255)<<0,this.color_number=this.cube.colors++),this},a.prototype.closestColor=function(a,b,c,d){var e,f,g;if(this.nchild!==0){for(g=0;g<=7;g++)this.child[g]!=null&&this.child[g].closestColor(a,b,c,d);this.unique!==0&&(e=this.cube.colormap[this.color_number],f=this.distance(e,a,b,c),f<d.distance&&(d.distance=f,d.color_number=this.color_number))}return this},a.prototype.distance=function(a,b,c,d){return SQUARES[(a>>16&255)-b+MAX_RGB]+SQUARES[(a>>8&255)-c+MAX_RGB]+SQUARES[(a>>0&255)-d+MAX_RGB]},a}();