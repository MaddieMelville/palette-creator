var Cube,MAX_NODES,MAX_RGB,MAX_TREE_DEPTH,Node,OctreeQuant,QUICK,SHIFT,SQUARES,Search,_ref,_result,log,onmessage,x;onmessage=function(c){var b,a,d;b=c.data;if(b.type==="quantize"){d=new OctreeQuant();a=d.quantizeImage(b.pixels,b.colors);return postMessage({type:"palette",palette:a})}};log=function(a){return postMessage({type:"log",message:a})};QUICK=true;MAX_RGB=255;MAX_NODES=266817;MAX_TREE_DEPTH=8;SQUARES=(function(){_result=[];_ref=-MAX_RGB;for(x=_ref;(_ref<=MAX_RGB?x<=MAX_RGB:x>=MAX_RGB);(_ref<=MAX_RGB?x+=1:x-=1)){_result.push(x*x)}return _result})();SHIFT=(function(){_result=[];for(x=0;(0<=MAX_TREE_DEPTH?x<=MAX_TREE_DEPTH:x>=MAX_TREE_DEPTH);(0<=MAX_TREE_DEPTH?x+=1:x-=1)){_result.push(1<<(15-x))}return _result})();OctreeQuant=function(){return this};OctreeQuant.prototype.quantizeImage=function(h,e){var g,c,f,a,d,b;a=new Cube(h,e);a.classification();a.reduction();a.assignment();b=[];f=a.colormap;g=f.length-1;for(d=0;(0<=g?d<=g:d>=g);(0<=g?d+=1:d-=1)){c=f[d];b.push((c>>16)&255);b.push((c>>8)&255);b.push((c>>0)&255);b.push(255)}return b};Cube=function(b,a){this.pixels=b;this.max_colors=a;this.colormap=null;this.root=null;this.depth=0;this.colors=0;this.nodes=0;this.depth=Math.floor(Math.log(a)/Math.log(4))+1;if(this.depth>MAX_TREE_DEPTH){this.depth=MAX_TREE_DEPTH}else{if(this.depth<2){this.depth=2}}this.root=new Node(this);return this};Cube.prototype.classification=function(){var f,d,m,h,j,b,g,k,a,c,e;k=Math.floor(this.pixels.length/4);f=k-1;for(g=0;(0<=f?g<=f:g>=f);(0<=f?g+=1:g-=1)){j=g<<2;e=this.pixels[j];h=this.pixels[j+1];m=this.pixels[j+2];if(this.nodes>MAX_NODES){this.root.pruneLevel();this.depth--}c=this.root;d=this.depth;for(a=1;(1<=d?a<=d:a>=d);(1<=d?a+=1:a-=1)){b=(((e>c.mid_red?1:0)<<0)|((h>c.mid_green?1:0)<<1)|((m>c.mid_blue?1:0)<<2));if(!(c.child[b]!=null)){new Node(c,b,a)}c=c.child[b];c.number_pixels+=SHIFT[a]}c.unique++;c.total_red+=e;c.total_green+=h;c.total_blue+=m}return this};Cube.prototype.reduction=function(){var a;a=1;while(this.colors>this.max_colors){this.colors=0;a=this.root.reduce(a,Number.MAX_VALUE)}return this};Cube.prototype.assignment=function(){var e,k,g,h,b,f,j,c,a,d,m;this.colormap=[];this.colors=0;this.root.colormap();m=new Search();j=this.pixels.length;e=j-1;for(f=0;(0<=e?f<=e:f>=e);(0<=e?f+=1:f-=1)){h=f<<2;d=this.pixels[h];g=this.pixels[h+1];k=this.pixels[h+2];c=this.root;while(true){b=(((d>c.mid_red?1:0)<<0)|((g>c.mid_green?1:0)<<1)|((k>c.mid_blue?1:0)<<2));if(!(c.child[b]!=null)){break}c=c.child[b]}if(QUICK){a=c.color_number}else{m.distance=Number.MAX_VALUE;c.parent.closestColor(d,g,k,m);a=m.color_number}this.pixels[h]=(a>>16)&255;this.pixels[h+1]=(a>>8)&255;this.pixels[h+2]=(a>>0)&255}return this};Search=function(){this.distance=0;this.color_number=0;return this};Node=function(b,d,c){var a;this.cube=null;this.parent=null;this.child=null;this.nchild=0;this.id=0;this.level=0;this.mid_red=0;this.mid_green=0;this.mid_blue=0;this.number_pixels=0;this.unique=0;this.total_red=0;this.total_green=0;this.total_blue=0;this.color_number=0;if(!(d!=null)||!(c!=null)){this.cube=b;this.parent=this;this.child=[];this.id=0;this.level=0;this.number_pixels=Number.MAX_VALUE;this.mid_red=(MAX_RGB+1)>>1;this.mid_green=(MAX_RGB+1)>>1;this.mid_blue=(MAX_RGB+1)>>1}else{this.cube=b.cube;this.parent=b;this.child=[];this.id=d;this.level=c;this.cube.nodes++;if(this.level===this.cube.depth){this.cube.colors++}this.parent.nchild++;this.parent.child[this.id]=this;a=(1<<(MAX_TREE_DEPTH-c))>>1;this.mid_red=this.parent.mid_red+((this.id&1)>(0!=null)?0:{bi:-a});this.mid_green=this.parent.mid_green+((this.id&2)>(0!=null)?0:{bi:-a});this.mid_blue=this.parent.mid_blue+((this.id&4)>(0!=null)?0:{bi:-a})}return this};Node.prototype.pruneChild=function(){this.parent.nchild--;this.parent.unique+=this.unique;this.parent.total_red+=this.total_red;this.parent.total_green+=this.total_green;this.parent.total_blue+=this.total_blue;this.parent.child[this.id]=null;this.cube.nodes--;this.cube=null;this.parent=null;return this};Node.prototype.pruneLevel=function(){var a;if(this.nchild!==0){for(a=0;a<=7;a++){if(this.child[a]!=null){this.child[a].pruneLevel()}}}if(this.level===this.cube.depth){this.pruneChild()}return this};Node.prototype.reduce=function(a,b){var c;if(this.nchild!==0){for(c=0;c<=7;c++){if(this.child[c]!=null){b=this.child[c].reduce(a,b)}}}if(this.number_pixels<=a){this.pruneChild()}else{if(this.unique!==0){this.cube.colors++}if(this.number_pixels<b){b=this.number_pixels}}return b};Node.prototype.colormap=function(){var a,b,d,c;if(this.nchild!==0){for(d=0;d<=7;d++){if(this.child[d]!=null){this.child[d].colormap()}}}if(this.unique!==0){c=((this.total_red+(this.unique>>1))/this.unique);b=((this.total_green+(this.unique>>1))/this.unique);a=((this.total_blue+(this.unique>>1))/this.unique);this.cube.colormap[this.cube.colors]=(((255)<<24)|((c&255)<<16)|((b&255)<<8)|((a&255)<<0));this.color_number=this.cube.colors++}return this};Node.prototype.closestColor=function(e,d,a,c){var b,g,f;if(this.nchild!==0){for(f=0;f<=7;f++){if(this.child[f]!=null){this.child[f].closestColor(e,d,a,c)}}if(this.unique!==0){b=this.cube.colormap[this.color_number];g=this.distance(b,e,d,a);if(g<c.distance){c.distance=g;c.color_number=this.color_number}}}return this};Node.prototype.distance=function(b,d,c,a){return SQUARES[((b>>16)&255)-d+MAX_RGB]+SQUARES[((b>>8)&255)-c+MAX_RGB]+SQUARES[((b>>0)&255)-a+MAX_RGB]};